import streamlit as st
import pandas as pd
import numpy as np
import torch
import plotly.graph_objects as go
import yfinance as yf
from ta.momentum import RSIIndicator
from ta.trend import MACD, EMAIndicator
from sklearn.preprocessing import MinMaxScaler
from model import StockTransformer
import nltk
from nltk.sentiment.vader import SentimentIntensityAnalyzer
from GoogleNews import GoogleNews

# --- Download NLTK VADER Lexicon ---
try:
    nltk.data.find('vader_lexicon')
except LookupError:
    nltk.download('vader_lexicon')

# --- Settings ---
DEVICE = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
MODEL_PATH = "transformer_stock_model.pth"

# --- Page Config ---
st.set_page_config(page_title="Stock Transformer AI", layout="wide")
st.title("ðŸ“ˆ AI Stock Predictor: The Ultimate Dashboard")

# --- Helper Functions ---

def fetch_stock_data(ticker):
    """Fetches historical data"""
    try:
        data = yf.download(ticker, period="2y", interval="1d")
        if data.empty: return None
        if isinstance(data.columns, pd.MultiIndex):
            data.columns = data.columns.get_level_values(0)
        
        # Technical Indicators
        data['RSI'] = RSIIndicator(close=data['Close'], window=14).rsi()
        macd = MACD(close=data['Close'])
        data['MACD'] = macd.macd()
        data['EMA_20'] = EMAIndicator(close=data['Close'], window=20).ema_indicator()
        data.dropna(inplace=True)
        return data
    except Exception as e:
        return None

def fetch_fundamentals(ticker):
    """Fetches Fundamental Data (P/E, Market Cap, etc.)"""
    try:
        ticker_obj = yf.Ticker(ticker)
        info = ticker_obj.info
        return {
            "Market Cap": info.get("marketCap", "N/A"),
            "P/E Ratio": info.get("trailingPE", "N/A"),
            "52W High": info.get("fiftyTwoWeekHigh", "N/A"),
            "Sector": info.get("sector", "N/A"),
            "Business Summary": info.get("longBusinessSummary", "No summary available.")[:200] + "..."
        }
    except Exception as e:
        return None

def fetch_news_google(ticker):
    """Fetches news using GoogleNews (Robust for India)"""
    try:
        clean_ticker = ticker.replace(".NS", "")
        googlenews = GoogleNews(lang='en', region='IN')
        googlenews.clear()
        googlenews.search(f"{clean_ticker} stock financial news")
        googlenews.get_page(1)
        news_list = googlenews.results()
        
        if not news_list: return None, 0

        sia = SentimentIntensityAnalyzer()
        headlines = []
        total_score = 0
        
        for item in news_list[:5]:
            title = item.get('title', '')
            link = item.get('link', '#')
            if not title: continue
            score = sia.polarity_scores(title)['compound']
            total_score += score
            headlines.append({'title': title, 'score': score, 'link': link})
            
        if not headlines: return None, 0
        return headlines, total_score / len(headlines)
    except:
        return None, 0

def preprocess_live_data(df):
    feature_cols = ['Close', 'RSI', 'MACD', 'EMA_20']
    scaler = MinMaxScaler(feature_range=(0, 1))
    data_scaled = scaler.fit_transform(df[feature_cols].values)
    
    sequence_length = 60
    X = []
    y = [] # Not used for live inference but kept for structure
    for i in range(len(data_scaled) - sequence_length):
        X.append(data_scaled[i : i + sequence_length])
        y.append(data_scaled[i + sequence_length, 0])
        
    X_tensor = torch.tensor(np.array(X), dtype=torch.float32).to(DEVICE)
    return X_tensor, scaler, data_scaled

@st.cache_resource
def load_model():
    model = StockTransformer(input_dim=4, d_model=64, nhead=4, num_layers=2, dropout=0.1)
    model.load_state_dict(torch.load(MODEL_PATH, map_location=DEVICE))
    model.to(DEVICE)
    model.eval()
    return model

# --- Sidebar ---
st.sidebar.header("ðŸ” Control Panel")
default_ticker = "RELIANCE.NS"
ticker_input = st.sidebar.text_input("Enter Ticker Symbol", default_ticker)

if st.sidebar.button("Run Analysis"):
    st.session_state['ticker'] = ticker_input
else:
    if 'ticker' not in st.session_state: st.session_state['ticker'] = default_ticker

current_ticker = st.session_state['ticker']
model = load_model()

# --- Main App ---

# 1. Fetch ALL Data
with st.spinner(f"Gathering Satellite Data for {current_ticker}..."):
    df = fetch_stock_data(current_ticker)
    fundamentals = fetch_fundamentals(current_ticker)
    headlines, sentiment_score = fetch_news_google(current_ticker)

if df is not None:
    # --- SECTION 1: FUNDAMENTALS (New Feature) ---
    if fundamentals:
        st.subheader("ðŸ¢ Company Fundamentals")
        c1, c2, c3, c4 = st.columns(4)
        
        # Helper to format large numbers
        def format_large(num):
            if isinstance(num, (int, float)):
                if num > 1e12: return f"â‚¹{num/1e12:.2f}T"
                if num > 1e9: return f"â‚¹{num/1e9:.2f}B"
            return num

        c1.metric("Market Cap", format_large(fundamentals["Market Cap"]))
        c2.metric("P/E Ratio", fundamentals["P/E Ratio"])
        c3.metric("52-Week High", f"â‚¹{fundamentals['52W High']}")
        c4.metric("Sector", fundamentals["Sector"])
        st.caption(f"**Summary:** {fundamentals['Business Summary']}")
        st.divider()

    # --- SECTION 2: AI PREDICTION ---
    X_tensor, scaler, full_data_scaled = preprocess_live_data(df)
    
    with torch.no_grad():
        predictions_scaled = model(X_tensor).cpu().numpy()

    # Inverse Scale
    def inverse_scale(scaled, scaler):
        dummy = np.zeros((len(scaled), 4))
        dummy[:, 0] = scaled.flatten()
        return scaler.inverse_transform(dummy)[:, 0]

    predicted_prices = inverse_scale(predictions_scaled, scaler)
    actual_prices = df['Close'].values[60:] # Adjust for sequence length offset

    # Next Day Prediction
    last_seq = torch.tensor(full_data_scaled[-60:], dtype=torch.float32).unsqueeze(0).to(DEVICE)
    with torch.no_grad():
        future_scaled = model(last_seq).item()
    
    dummy_fut = np.zeros((1, 4))
    dummy_fut[0, 0] = future_scaled
    future_price = scaler.inverse_transform(dummy_fut)[0, 0]
    current_price = df['Close'].iloc[-1]
    price_change = future_price - current_price
    
    # Dashboard
    st.subheader("ðŸ”® AI Prediction Dashboard")
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("Current Price", f"â‚¹{current_price:.2f}")
    col2.metric("Tomorrow's Prediction", f"â‚¹{future_price:.2f}", delta=f"{price_change:.2f}")
    
    # Sentiment & Verdict
    sent_label = "Neutral âšª"
    if sentiment_score > 0.15: sent_label = "Positive ðŸŸ¢"
    elif sentiment_score < -0.15: sent_label = "Negative ðŸ”´"
    
    col3.metric("News Sentiment", sent_label, delta=f"{sentiment_score:.2f}")
    
    verdict = "HOLD âœ‹"
    if price_change > 0 and sentiment_score > 0: verdict = "STRONG BUY ðŸš€"
    elif price_change < 0 and sentiment_score < 0: verdict = "STRONG SELL ðŸ“‰"
    elif price_change > 0 and sentiment_score < 0: verdict = "CAUTION âš ï¸"
    
    col4.markdown(f"**AI Verdict:** `{verdict}`")

    # Chart
    fig = go.Figure()
    fig.add_trace(go.Scatter(y=actual_prices[-200:], mode='lines', name='Actual', line=dict(color='#00BFFF')))
    fig.add_trace(go.Scatter(y=predicted_prices[-200:], mode='lines', name='AI Predicted', line=dict(color='#FF4B4B', dash='dash')))
    fig.update_layout(title=f"{current_ticker} (Last 200 Days)", height=500, template="plotly_dark")
    st.plotly_chart(fig, use_container_width=True)

    # --- SECTION 3: BACKTESTING ---
    with st.expander("ðŸ’° View Virtual Profit Backtest (Proof of Concept)"):
        st.write("### Strategy: Start with â‚¹10,000")
        initial = 10000
        cash = initial
        shares = 0
        in_market = False
        
        for i in range(len(predicted_prices)-1):
            curr = actual_prices[i]
            pred = predicted_prices[i+1]
            if pred > curr * 1.005 and not in_market:
                shares = cash / curr; cash = 0; in_market = True
            elif pred < curr and in_market:
                cash = shares * curr; shares = 0; in_market = False
        
        final_val = shares * actual_prices[-1] if in_market else cash
        ret = ((final_val - initial)/initial)*100
        buy_hold = initial * (actual_prices[-1]/actual_prices[0])
        
        b1, b2 = st.columns(2)
        b1.metric("Buy & Hold Result", f"â‚¹{buy_hold:.2f}")
        b2.metric("AI Strategy Result", f"â‚¹{final_val:.2f}", delta=f"{ret:.1f}%")

    # --- SECTION 4: NEWS ---
    st.subheader("ðŸ“° Relevant News")
    if headlines:
        for news in headlines:
            st.write(f"**{news['title']}** (Sentiment: {news['score']:.2f})")
    else:
        st.write("No news found.")

else:
    st.error("Error: Could not fetch data. Please check ticker symbol.")